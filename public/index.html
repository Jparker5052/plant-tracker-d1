<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen"></div>
    
    <script>
    // Plant Tracker App - Professional Version
    let currentRole = localStorage.getItem('role') || null;
    let plants = [];
    let rooms = [];
    let filters = { status: null, search: '' };

    // API Configuration
    const API_BASE = '/api';

    // Initialize app
    async function init() {
        if (!currentRole) {
            showRoleSelector();
        } else {
            await loadData();
            showDashboard();
        }
    }

    // Show role selector
    function showRoleSelector() {
        document.getElementById('app').innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                    <h1 class="text-3xl font-bold text-center mb-2">ðŸŒ± Plant Tracker</h1>
                    <p class="text-gray-600 text-center mb-6">Select your identity</p>
                    <div class="space-y-2">
                        <button onclick="selectRole('Ben')" class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Ben</button>
                        <button onclick="selectRole('Jared')" class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Jared</button>
                        <button onclick="selectRole('Guest1')" class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Guest1</button>
                        <button onclick="selectRole('Guest2')" class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Guest2</button>
                    </div>
                </div>
            </div>
        `;
    }

    // Select role
    async function selectRole(role) {
        currentRole = role;
        localStorage.setItem('role', role);
        await loadData();
        showDashboard();
    }

    // Load data from API
    async function loadData() {
        try {
            const [roomsRes, plantsRes] = await Promise.all([
                fetch(API_BASE + '/rooms'),
                fetch(API_BASE + '/plants')
            ]);
            
            rooms = await roomsRes.json();
            plants = await plantsRes.json();
            
            // Calculate status for each plant
            plants = plants.map(plant => {
                const status = calculatePlantStatus(plant);
                return { ...plant, ...status };
            });
            
            // Sort by urgency
            plants.sort((a, b) => {
                const order = { 'Due': 0, 'Needs Check': 1, 'Snoozed': 2, 'OK': 3 };
                return order[a.status] - order[b.status];
            });
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    // Calculate plant status
    function calculatePlantStatus(plant) {
        if (!plant.lastWateredAt) {
            return { status: 'Due', daysUntilWater: 0, daysSince: 'Never' };
        }
        
        const now = new Date();
        const lastWatered = new Date(plant.lastWateredAt);
        const daysSince = Math.floor((now - lastWatered) / (1000 * 60 * 60 * 24));
        const daysUntilWater = plant.waterIntervalDays - daysSince;
        
        let status;
        if (daysUntilWater <= 0) {
            status = 'Due';
        } else if (daysUntilWater <= 2) {
            status = 'Needs Check';
        } else {
            status = 'OK';
        }
        
        return { status, daysUntilWater, daysSince };
    }

    // Show dashboard
    function showDashboard() {
        // Apply filters
        let filteredPlants = [...plants];
        if (filters.status) {
            filteredPlants = filteredPlants.filter(p => p.status === filters.status);
        }
        if (filters.search) {
            const search = filters.search.toLowerCase();
            filteredPlants = filteredPlants.filter(p => 
                p.species.toLowerCase().includes(search) || 
                (p.nickname && p.nickname.toLowerCase().includes(search))
            );
        }

        // Count statuses
        const statusCounts = {
            'Due': plants.filter(p => p.status === 'Due').length,
            'Needs Check': plants.filter(p => p.status === 'Needs Check').length,
            'OK': plants.filter(p => p.status === 'OK').length
        };

        document.getElementById('app').innerHTML = `
            <div class="max-w-6xl mx-auto p-4">
                <!-- Header -->
                <div class="bg-white rounded-lg shadow mb-4 p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h1 class="text-2xl font-bold">ðŸŒ± Plant Tracker</h1>
                        <div>
                            <span class="text-sm text-gray-600">Logged in as: </span>
                            <span class="font-medium">${currentRole}</span>
                        </div>
                    </div>
                    
                    <!-- Status Filters -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="setStatusFilter('Due')" 
                                class="${filters.status === 'Due' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700'} px-3 py-1 rounded-full text-sm">
                            Due (${statusCounts['Due']})
                        </button>
                        <button onclick="setStatusFilter('Needs Check')" 
                                class="${filters.status === 'Needs Check' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'} px-3 py-1 rounded-full text-sm">
                            Needs Check (${statusCounts['Needs Check']})
                        </button>
                        <button onclick="setStatusFilter('OK')" 
                                class="${filters.status === 'OK' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'} px-3 py-1 rounded-full text-sm">
                            OK (${statusCounts['OK']})
                        </button>
                        ${filters.status ? `
                            <button onclick="setStatusFilter(null)" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">
                                Clear
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Search -->
                    <input type="text" 
                           placeholder="Search plants..." 
                           oninput="filters.search = this.value; showDashboard()"
                           value="${filters.search}"
                           class="w-full p-2 border rounded-lg">
                </div>

                <!-- Add Plant Button -->
                ${plants.length < 50 ? `
                    <button onclick="showAddPlantForm()" 
                            class="mb-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        + Add New Plant
                    </button>
                ` : `
                    <div class="mb-4 p-3 bg-yellow-100 rounded-lg">
                        <p class="text-yellow-800">Maximum 50 plants reached!</p>
                    </div>
                `}

                <!-- Plants List -->
                <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
                    ${filteredPlants.length === 0 ? `
                        <div class="col-span-full bg-white p-8 rounded-lg text-center text-gray-500">
                            ${plants.length === 0 ? 'No plants yet. Add your first plant!' : 'No plants match your filters.'}
                        </div>
                    ` : filteredPlants.map(plant => `
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${plant.nickname || plant.species}</h3>
                                    ${plant.nickname ? `<p class="text-sm text-gray-600">${plant.species}</p>` : ''}
                                </div>
                                <span class="${
                                    plant.status === 'Due' ? 'bg-red-500' :
                                    plant.status === 'Needs Check' ? 'bg-yellow-500' :
                                    'bg-green-500'
                                } text-white px-2 py-1 rounded-full text-xs">
                                    ${plant.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">
                                Room: ${rooms.find(r => r.id === plant.roomId)?.name || 'Unknown'} | 
                                Light: ${plant.lightLevel} | 
                                Every ${plant.waterIntervalDays} days
                            </p>
                            <p class="text-sm text-gray-500 mb-3">
                                Last watered: ${plant.daysSince === 'Never' ? 'Never' : plant.daysSince + ' days ago'}
                            </p>
                            <div class="flex gap-2">
                                <button onclick="waterPlant(${plant.id})" 
                                        class="flex-1 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                    ðŸ’§ Water
                                </button>
                                <button onclick="showPlantDetails(${plant.id})" 
                                        class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                    Details
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Footer -->
                <div class="mt-8 text-center text-sm text-gray-500">
                    <button onclick="loadData().then(showDashboard)" class="text-blue-500 hover:underline">Refresh</button>
                    <span class="mx-2">|</span>
                    <button onclick="localStorage.clear(); location.reload()" class="text-gray-500 hover:underline">Change Role</button>
                    <span class="mx-2">|</span>
                    <button onclick="exportData()" class="text-gray-500 hover:underline">Export Data</button>
                </div>
            </div>
        `;
    }

    // Set status filter
    function setStatusFilter(status) {
        filters.status = filters.status === status ? null : status;
        showDashboard();
    }

    // Show add plant form
    function showAddPlantForm() {
        document.getElementById('app').innerHTML = `
            <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Add New Plant</h2>
                <form onsubmit="event.preventDefault(); addPlant()">
                    <input type="text" id="species" placeholder="Species" required class="w-full p-2 border rounded mb-3">
                    <input type="text" id="nickname" placeholder="Nickname (optional)" class="w-full p-2 border rounded mb-3">
                    <select id="roomId" required class="w-full p-2 border rounded mb-3">
                        ${rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                    </select>
                    <select id="lightLevel" required class="w-full p-2 border rounded mb-3">
                        <option value="low">Low Light</option>
                        <option value="medium">Medium Light</option>
                        <option value="bright">Bright Light</option>
                        <option value="direct">Direct Sun</option>
                    </select>
                    <input type="number" id="waterIntervalDays" placeholder="Water every X days" value="7" min="1" max="60" required class="w-full p-2 border rounded mb-3">
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 p-2 bg-green-500 text-white rounded hover:bg-green-600">Add Plant</button>
                        <button type="button" onclick="showDashboard()" class="flex-1 p-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                    </div>
                </form>
            </div>
        `;
    }

    // Add plant
    async function addPlant() {
        const plantData = {
            species: document.getElementById('species').value,
            nickname: document.getElementById('nickname').value,
            roomId: parseInt(document.getElementById('roomId').value),
            lightLevel: document.getElementById('lightLevel').value,
            waterIntervalDays: parseInt(document.getElementById('waterIntervalDays').value),
            fertilizeIntervalDays: 30,
            addedBy: currentRole
        };
        
        try {
            await fetch(API_BASE + '/plants', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(plantData)
            });
            await loadData();
            showDashboard();
        } catch (error) {
            alert('Error adding plant: ' + error.message);
        }
    }

    // Water plant
    async function waterPlant(plantId) {
        try {
            await fetch(API_BASE + '/plants/' + plantId + '/water', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ performedBy: currentRole })
            });
            await loadData();
            showDashboard();
            alert('Plant watered successfully!');
        } catch (error) {
            alert('Error watering plant: ' + error.message);
        }
    }

    // Show plant details
    async function showPlantDetails(plantId) {
        const plant = plants.find(p => p.id === plantId);
        const eventsRes = await fetch(API_BASE + '/plants/' + plantId + '/events');
        const events = await eventsRes.json();
        
        const historyHtml = events.length > 0 ? events.map(e => `
            <div class="border-l-2 pl-2 mb-2">
                <p class="text-sm"><b>${e.performedBy}</b> - ${e.eventType}</p>
                <p class="text-xs text-gray-500">${new Date(e.performedAt).toLocaleString()}</p>
            </div>
        `).join('') : '<p class="text-gray-500">No history yet</p>';
        
        document.getElementById('app').innerHTML = `
            <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">${plant.nickname || plant.species}</h2>
                <div class="mb-4">
                    <p><b>Species:</b> ${plant.species}</p>
                    <p><b>Room:</b> ${rooms.find(r => r.id === plant.roomId)?.name}</p>
                    <p><b>Light:</b> ${plant.lightLevel}</p>
                    <p><b>Water Interval:</b> ${plant.waterIntervalDays} days</p>
                    <p><b>Added by:</b> ${plant.addedBy}</p>
                </div>
                <h3 class="font-bold mb-2">Care History</h3>
                <div class="max-h-60 overflow-y-auto mb-4">${historyHtml}</div>
                <div class="flex gap-2">
                    <button onclick="showDashboard()" class="flex-1 p-2 bg-gray-300 rounded hover:bg-gray-400">Back</button>
                    <button onclick="deletePlant(${plant.id})" class="flex-1 p-2 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
                </div>
            </div>
        `;
    }

    // Delete plant
    async function deletePlant(plantId) {
        if (!confirm('Delete this plant?')) return;
        
        try {
            await fetch(API_BASE + '/plants/' + plantId, { method: 'DELETE' });
            await loadData();
            showDashboard();
        } catch (error) {
            alert('Error deleting plant: ' + error.message);
        }
    }

    // Export data
    function exportData() {
        const data = {
            exportDate: new Date().toISOString(),
            plants: plants,
            rooms: rooms
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'plant-tracker-export.json';
        a.click();
    }

    // Start app
    init();
    </script>
</body>
</html>

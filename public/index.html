<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Plant Gays</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a1a1a;
        }
        
        .dark-mode .bg-white {
            background-color: #2a2a2a !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #333 !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #3a3a3a !important;
        }
        
        .dark-mode .bg-blue-50 {
            background-color: #1a2332 !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #1a2f1a !important;
        }
        
        .dark-mode .text-gray-900 {
            color: #f0f0f0 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #b0b0b0 !important;
        }
        
        .dark-mode .text-gray-500 {
            color: #999 !important;
        }
        
        .dark-mode .border-gray-300 {
            border-color: #555 !important;
        }
        
        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background-color: #3a3a3a !important;
            color: #f0f0f0 !important;
            border-color: #555 !important;
        }
        
        .dark-mode .hover\:bg-gray-50:hover {
            background-color: #3a3a3a !important;
        }
        
        .dark-mode .hover\:bg-gray-100:hover {
            background-color: #444 !important;
        }
        
        /* Status card styles */
        .plant-card-due {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
        }
        
        .plant-card-check {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #d97706;
        }
        
        .plant-card-snoozed {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #2563eb;
        }
        
        .plant-card-ok {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid #16a34a;
        }
        
        .dark-mode .plant-card-due {
            background: linear-gradient(135deg, #4a1f1f 0%, #5a2020 100%);
        }
        
        .dark-mode .plant-card-check {
            background: linear-gradient(135deg, #4a3f1f 0%, #5a4020 100%);
        }
        
        .dark-mode .plant-card-snoozed {
            background: linear-gradient(135deg, #1f2f4a 0%, #20305a 100%);
        }
        
        .dark-mode .plant-card-ok {
            background: linear-gradient(135deg, #1f3a2a 0%, #204a30 100%);
        }
        
        .slide-panel { 
            animation: slideUp 0.3s ease-out;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 90vh;
            z-index: 50;
        }
        
        @keyframes slideUp { 
            from { transform: translateY(100%); } 
            to { transform: translateY(0); } 
        }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <div id="app"></div>
    <div id="quickPanel"></div>
    <div id="toast" class="fixed top-4 right-4 z-50"></div>

    <script>
    // =====================================
    // PLANT TRACKER - REFINED VERSION
    // =====================================

    const APP = {
        role: localStorage.getItem('role') || null,
        darkMode: localStorage.getItem('darkMode') === 'true',
        plants: [],
        rooms: [],
        careEvents: [],
        filters: {
            status: null,
            room: null,
            search: ''
        },
        collapsedRooms: new Set(),
        selectedPlant: null,
        adaptiveIntervals: {}
    };

    // Apply dark mode on load
    if (APP.darkMode) {
        document.body.classList.add('dark-mode');
    }

    // =====================================
    // STATUS LOGIC
    // =====================================
    
    function calculatePlantStatus(plant, careEvents = []) {
        const now = new Date();
        
        let daysSinceWater = null;
        let daysUntilWater = null;
        
        if (plant.lastWateredAt) {
            const lastWatered = new Date(plant.lastWateredAt);
            daysSinceWater = Math.floor((now - lastWatered) / (86400000));
            daysUntilWater = plant.waterIntervalDays - daysSinceWater;
        } else {
            daysUntilWater = -plant.waterIntervalDays;
        }
        
        // Check for active snooze
        const snoozeEvents = careEvents.filter(e => 
            e.plantId === plant.id && 
            e.eventType === 'snooze'
        ).sort((a, b) => new Date(b.performedAt) - new Date(a.performedAt));
        
        let snoozedUntil = null;
        if (snoozeEvents.length > 0) {
            const lastSnooze = snoozeEvents[0];
            const snoozeEnd = new Date(lastSnooze.performedAt);
            snoozeEnd.setDate(snoozeEnd.getDate() + (lastSnooze.snoozeDays || 0));
            if (snoozeEnd > now) {
                snoozedUntil = snoozeEnd.toISOString();
            }
        }
        
        let status = 'OK';
        let urgency = 3;
        
        if (snoozedUntil) {
            status = 'Snoozed';
            urgency = 2;
        } else if (daysUntilWater <= 0) {
            status = 'Due';
            urgency = 0;
        } else if (daysUntilWater <= 2) {
            status = 'Needs Check';
            urgency = 1;
        }
        
        return {
            status,
            urgency,
            daysUntilWater,
            daysSinceWater,
            snoozedUntil
        };
    }

    // =====================================
    // UTILITIES
    // =====================================

    function formatLocalDateTime(dateStr) {
        if (!dateStr) return 'Never';
        
        // Handle both ISO strings and database datetime format
        let date;
        if (dateStr.includes('T')) {
            // ISO format
            date = new Date(dateStr);
        } else {
            // Database format (YYYY-MM-DD HH:MM:SS) - assume it's UTC
            date = new Date(dateStr.replace(' ', 'T') + 'Z');
        }
        
        // Return in user's local timezone
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        });
    }

    function formatEventType(event) {
        const eventType = event.eventType || event.type;
        let description = '';
        
        switch(eventType) {
            case 'water': 
                description = `💧 Watered`;
                if (event.intervalDaysChosen) {
                    description += ` (${event.intervalDaysChosen}d interval)`;
                }
                if (event.soilMoisture) {
                    description += ` - ${event.soilMoisture}`;
                }
                break;
            case 'check':
                description = `👁️ Checked`;
                if (event.soilMoisture) {
                    description += ` - Soil: ${event.soilMoisture}`;
                }
                break;
            case 'snooze':
                description = `⏰ Snoozed for ${event.snoozeDays || '?'} days`;
                break;
            case 'fertilize':
                description = '🌿 Fertilized';
                break;
            case 'note':
                description = '📝 Note added';
                break;
            default:
                description = eventType || 'Unknown action';
        }
        
        return description;
    }

    function showToast(message, type = 'info') {
        const colors = {
            success: APP.darkMode ? 'bg-green-700' : 'bg-green-600',
            error: APP.darkMode ? 'bg-red-700' : 'bg-red-600',
            warning: APP.darkMode ? 'bg-yellow-700' : 'bg-yellow-600',
            info: APP.darkMode ? 'bg-blue-700' : 'bg-blue-600'
        };
        
        const toast = document.createElement('div');
        toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 animate-pulse`;
        toast.textContent = message;
        
        document.getElementById('toast').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // =====================================
    // UI RENDERING
    // =====================================

    function renderApp() {
        if (!APP.role) {
            renderRoleSelector();
        } else {
            renderDashboard();
        }
    }

    function renderRoleSelector() {
        document.getElementById('app').innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                    <h1 class="text-3xl font-bold text-center mb-2 text-gray-900">🌱 Plant Tracker</h1>
                    <p class="text-gray-600 text-center mb-6">
                        Track shared houseplants. Optimized for quick daily check-ins.
                    </p>
                    <p class="font-medium mb-4 text-gray-900">Select your role:</p>
                    <div class="space-y-3">
                        ${['Ben', 'Jared', 'Guest1', 'Guest2'].map(role => `
                            <button 
                                onclick="selectRole('${role}')"
                                class="w-full p-4 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium text-lg transition-colors"
                            >
                                ${role}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderDashboard() {
        // Calculate status for all plants
        const plantsWithStatus = APP.plants.map(plant => ({
            ...plant,
            statusInfo: calculatePlantStatus(plant, APP.careEvents)
        }));
        
        // Apply filters
        let filteredPlants = plantsWithStatus;
        
        if (APP.filters.status) {
            filteredPlants = filteredPlants.filter(p => p.statusInfo.status === APP.filters.status);
        }
        if (APP.filters.search) {
            const search = APP.filters.search.toLowerCase();
            filteredPlants = filteredPlants.filter(p => 
                p.species.toLowerCase().includes(search) ||
                (p.nickname && p.nickname.toLowerCase().includes(search))
            );
        }
        
        // Group by room and sort by urgency - ONLY rooms with plants
        const roomsWithPlants = [];
        APP.rooms.forEach(room => {
            const roomPlants = filteredPlants.filter(p => p.roomId == room.id);
            if (roomPlants.length > 0) {
                roomPlants.sort((a, b) => {
                    if (a.statusInfo.urgency !== b.statusInfo.urgency) {
                        return a.statusInfo.urgency - b.statusInfo.urgency;
                    }
                    return a.statusInfo.daysUntilWater - b.statusInfo.daysUntilWater;
                });
                roomsWithPlants.push({ room, plants: roomPlants });
            }
        });
        
        // Count statuses
        const statusCounts = {
            'Due': plantsWithStatus.filter(p => p.statusInfo.status === 'Due').length,
            'Needs Check': plantsWithStatus.filter(p => p.statusInfo.status === 'Needs Check').length,
            'Snoozed': plantsWithStatus.filter(p => p.statusInfo.status === 'Snoozed').length,
            'OK': plantsWithStatus.filter(p => p.statusInfo.status === 'OK').length
        };
        
        document.getElementById('app').innerHTML = `
            <!-- Dashboard Header -->
            <div class="sticky top-0 z-20 bg-white shadow-sm">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h1 class="text-2xl font-bold text-gray-900">Plant Tracker</h1>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Role</div>
                            <div class="font-medium text-gray-900">${APP.role}</div>
                        </div>
                    </div>
                    
                    <!-- Status Chips -->
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        ${Object.entries(statusCounts).map(([status, count]) => {
                            const colors = {
                                'Due': APP.filters.status === status ? 'bg-red-600' : 'bg-red-100 text-red-700',
                                'Needs Check': APP.filters.status === status ? 'bg-yellow-600' : 'bg-yellow-100 text-yellow-700',
                                'Snoozed': APP.filters.status === status ? 'bg-blue-600' : 'bg-blue-100 text-blue-700',
                                'OK': APP.filters.status === status ? 'bg-green-600' : 'bg-green-100 text-green-700'
                            };
                            return `
                                <button 
                                    onclick="toggleFilter('status', '${status}')"
                                    class="${colors[status]} ${APP.filters.status === status ? 'text-white' : ''} px-3 py-1 rounded-full text-sm font-medium whitespace-nowrap"
                                >
                                    ${status} (${count})
                                </button>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Search -->
                    <div class="mt-2">
                        <input 
                            type="search"
                            placeholder="Search plants..."
                            value="${APP.filters.search}"
                            oninput="setFilter('search', this.value)"
                            class="w-full p-2 border rounded-lg border-gray-300"
                        />
                    </div>
                </div>
            </div>
            
            <!-- Plant Limit Warning -->
            ${APP.plants.length >= 45 ? `
                <div class="mx-4 mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        ⚠️ ${APP.plants.length}/50 plants (${50 - APP.plants.length} remaining)
                    </p>
                </div>
            ` : ''}
            
            <!-- Plants by Room (only rooms with plants) -->
            <div class="p-4 space-y-4">
                ${roomsWithPlants.length === 0 ? `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                        <p class="text-gray-500">No plants to display</p>
                    </div>
                ` : roomsWithPlants.map(({ room, plants }) => `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h2 class="font-semibold text-lg text-gray-900">${room.name} (${plants.length})</h2>
                        </div>
                        <div class="p-4 space-y-3">
                            ${plants.map(plant => renderPlantCard(plant)).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Add Plant FAB -->
            ${APP.plants.length < 50 ? `
                <button 
                    onclick="showAddPlantForm()"
                    class="fixed bottom-24 right-6 w-14 h-14 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 flex items-center justify-center"
                >
                    <span class="text-2xl">+</span>
                </button>
            ` : ''}
            
            <!-- Bottom Navigation -->
            <nav class="fixed bottom-0 left-0 right-0 bg-white border-t">
                <div class="grid grid-cols-3">
                    <button 
                        onclick="showRooms()"
                        class="py-4 text-center hover:bg-gray-50 text-gray-900"
                    >
                        <div>🏠</div>
                        <div class="text-xs">Rooms</div>
                    </button>
                    <button 
                        onclick="showExport()"
                        class="py-4 text-center hover:bg-gray-50 text-gray-900"
                    >
                        <div>📊</div>
                        <div class="text-xs">Export</div>
                    </button>
                    <button 
                        onclick="showSettings()"
                        class="py-4 text-center hover:bg-gray-50 text-gray-900"
                    >
                        <div>⚙️</div>
                        <div class="text-xs">Settings</div>
                    </button>
                </div>
            </nav>
        `;
    }

    function renderPlantCard(plant) {
        const statusClasses = {
            'Due': 'plant-card-due',
            'Needs Check': 'plant-card-check',
            'Snoozed': 'plant-card-snoozed',
            'OK': 'plant-card-ok'
        };
        
        const statusIcons = {
            'Due': '🚨',
            'Needs Check': '⚠️',
            'Snoozed': '😴',
            'OK': '✅'
        };
        
        return `
            <div 
                class="${statusClasses[plant.statusInfo.status]} rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                onclick="showQuickPanel(${plant.id})"
            >
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">
                            ${plant.nickname || plant.species}
                            <span class="ml-2">${statusIcons[plant.statusInfo.status]}</span>
                        </h3>
                        ${plant.nickname ? `<p class="text-sm text-gray-600">${plant.species}</p>` : ''}
                        <p class="text-sm text-gray-600 mt-1">
                            💧 ${plant.statusInfo.daysSinceWater !== null ? plant.statusInfo.daysSinceWater + 'd ago' : 'Never'} | 
                            Every ${plant.waterIntervalDays}d
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-medium text-gray-900">
                            ${plant.statusInfo.status}
                        </span>
                    </div>
                </div>
                ${plant.statusInfo.snoozedUntil ? `
                    <div class="mt-2 text-xs text-blue-600">
                        ⏰ Until ${new Date(plant.statusInfo.snoozedUntil).toLocaleDateString()}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function showQuickPanel(plantId) {
        const plant = APP.plants.find(p => p.id === plantId);
        if (!plant) return;
        
        const statusInfo = calculatePlantStatus(plant, APP.careEvents);
        
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6 overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">${plant.nickname || plant.species}</h2>
                        ${plant.nickname ? `<p class="text-gray-600">${plant.species}</p>` : ''}
                    </div>
                    <button onclick="closeQuickPanel()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-900">✕</button>
                </div>
                
                <!-- Core info -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-600">Last watered:</span>
                            <p class="font-medium text-gray-900">${plant.lastWateredAt ? formatLocalDateTime(plant.lastWateredAt) : 'Never'}</p>
                        </div>
                        <div>
                            <span class="text-gray-600">Status:</span>
                            <p class="font-medium text-gray-900">${statusInfo.status}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Watering Options -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <h3 class="font-medium mb-2 text-gray-900">Water Plant</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-xs text-gray-600">Interval (days)</label>
                            <input type="number" id="waterInterval" value="${plant.waterIntervalDays}" min="1" max="60" class="w-full p-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Moisture</label>
                            <select id="waterMoisture" class="w-full p-1 border rounded text-sm">
                                <option value="">Select...</option>
                                <option value="Fully Dry">Fully Dry</option>
                                <option value="Top Dry">Top Dry</option>
                                <option value="Moist" selected>Moist</option>
                                <option value="Wet">Wet</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="waterWithInterval(${plant.id})" class="w-full p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        💧 Water Now
                    </button>
                </div>
                
                <!-- Fertilize Options -->
                <div class="mb-4 p-3 bg-green-50 rounded-lg">
                    <h3 class="font-medium mb-2 text-gray-900">Fertilize Plant</h3>
                    <div class="text-xs text-gray-600 mb-2">
                        Last: ${plant.lastFertilizedAt ? formatLocalDateTime(plant.lastFertilizedAt) : 'Never'}
                    </div>
                    <button onclick="fertilizePlant(${plant.id})" class="w-full p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 mb-2">
                        🌿 Fertilize Now
                    </button>
                    <div class="text-xs text-gray-600 mb-1">Snooze Fertilizing:</div>
                    <div class="flex gap-2">
                        ${[7, 14, 30].map(d => `
                            <button onclick="snoozeFertilizer(${plant.id}, ${d})" class="flex-1 p-1 border rounded text-sm hover:bg-gray-50 text-gray-900">
                                ${d}d
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Check Only -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1 text-gray-900">Record Check Only</label>
                    <select id="checkMoisture" class="w-full p-2 border rounded-lg mb-2">
                        <option value="">Select moisture...</option>
                        <option value="Fully Dry">Fully Dry</option>
                        <option value="Top Dry">Top Dry</option>
                        <option value="Moist">Moist</option>
                        <option value="Wet">Wet</option>
                    </select>
                    <input type="text" id="quickNote" placeholder="Add note..." class="w-full p-2 border rounded-lg mb-2">
                    <button onclick="recordCheck(${plant.id})" class="w-full p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Record Check
                    </button>
                </div>
                
                <!-- Snooze Watering -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-gray-900">Snooze Watering</label>
                    <div class="flex gap-2">
                        ${[1, 2, 3, 5, 7].map(d => `
                            <button onclick="snoozeQuick(${plant.id}, ${d})" class="flex-1 p-2 border rounded-lg hover:bg-gray-50 text-gray-900">
                                ${d}d
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="showEditPlant(${plant.id})" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ✏️ Edit
                    </button>
                    <button onclick="showPlantDetails(${plant.id})" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        📜 History
                    </button>
                </div>
            </div>
        `;
    }

    function showEditPlant(plantId) {
        const plant = APP.plants.find(p => p.id === plantId);
        if (!plant) return;
        
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6 overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Edit Plant</h2>
                
                <form onsubmit="event.preventDefault(); updatePlant(${plant.id})">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Species</label>
                        <input type="text" id="editSpecies" value="${plant.species}" required class="w-full p-2 border rounded-lg">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Nickname</label>
                        <input type="text" id="editNickname" value="${plant.nickname || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Room</label>
                        <select id="editRoomId" required class="w-full p-2 border rounded-lg">
                            ${APP.rooms.map(r => `
                                <option value="${r.id}" ${r.id == plant.roomId ? 'selected' : ''}>${r.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Light Level</label>
                        <select id="editLightLevel" required class="w-full p-2 border rounded-lg">
                            <option value="low" ${plant.lightLevel === 'low' ? 'selected' : ''}>☁️ Low</option>
                            <option value="medium" ${plant.lightLevel === 'medium' ? 'selected' : ''}>⛅ Medium</option>
                            <option value="bright" ${plant.lightLevel === 'bright' ? 'selected' : ''}>☀️ Bright</option>
                            <option value="direct" ${plant.lightLevel === 'direct' ? 'selected' : ''}>🌞 Direct</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-900">Water Every (days)</label>
                            <input type="number" id="editWaterInterval" value="${plant.waterIntervalDays}" min="1" max="60" required class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-900">Fertilize Every (days)</label>
                            <input type="number" id="editFertilizeInterval" value="${plant.fertilizeIntervalDays || 30}" min="7" max="120" required class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        Save Changes
                    </button>
                </form>
                
                <button onclick="showQuickPanel(${plant.id})" class="w-full mt-2 p-2 text-gray-600 hover:text-gray-900">
                    Cancel
                </button>
            </div>
        `;
    }

    function showPlantDetails(plantId) {
        const plant = APP.plants.find(p => p.id === plantId);
        const events = APP.careEvents.filter(e => e.plantId === plantId)
            .sort((a, b) => new Date(b.performedAt || b.at) - new Date(a.performedAt || a.at));
        
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6 overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">${plant.nickname || plant.species}</h2>
                        ${plant.nickname ? `<p class="text-gray-600">${plant.species}</p>` : ''}
                    </div>
                    <button onclick="closeQuickPanel()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-900">✕</button>
                </div>
                
                <!-- Plant Info -->
                <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                    <div class="bg-gray-50 p-2 rounded">
                        <span class="text-gray-600">Room:</span>
                        <p class="font-medium text-gray-900">${APP.rooms.find(r => r.id == plant.roomId)?.name}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <span class="text-gray-600">Light:</span>
                        <p class="font-medium text-gray-900">${plant.lightLevel}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <span class="text-gray-600">Water:</span>
                        <p class="font-medium text-gray-900">Every ${plant.waterIntervalDays} days</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <span class="text-gray-600">Fertilize:</span>
                        <p class="font-medium text-gray-900">Every ${plant.fertilizeIntervalDays || 30} days</p>
                    </div>
                </div>
                
                <!-- Care History -->
                <h3 class="font-medium mb-2 text-gray-900">Care History</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${events.length === 0 ? '<p class="text-gray-500">No history yet</p>' : 
                    events.slice(0, 50).map(event => {
                        const eventType = event.eventType || event.type || 'unknown';
                        const isCheckEvent = eventType === 'check';
                        const hasDetails = event.soilMoisture || event.notes || event.note;
                        
                        // Only show events that have meaningful content
                        if (isCheckEvent && !hasDetails) {
                            return ''; // Skip check events with no details
                        }
                        
                        return `
                            <div class="border-l-2 border-gray-300 pl-3 pb-2">
                                <div class="flex items-start gap-2">
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-900">
                                            <strong>${event.role || event.performedBy || 'Unknown'}</strong>
                                            ${formatEventType(event)}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            ${formatLocalDateTime(event.performedAt || event.at)}
                                        </p>
                                        ${event.notes || event.note ? `
                                            <p class="text-xs italic text-gray-600 mt-1 bg-gray-50 p-1 rounded">
                                                "${event.notes || event.note}"
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).filter(item => item !== '').join('')}
                </div>
                
                <!-- Actions -->
                <div class="mt-4 space-y-2">
                    <button onclick="showEditPlant(${plant.id})" class="w-full p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Edit Plant Details
                    </button>
                    <button onclick="if(confirm('Delete this plant?')) deletePlant(${plant.id})" class="w-full p-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Delete Plant
                    </button>
                </div>
            </div>
        `;
    }

    function showSettings() {
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Settings</h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Current Role</p>
                        <p class="text-lg font-medium text-gray-900">${APP.role}</p>
                    </div>
                    
                    <button onclick="if(confirm('Change role?')) changeRole()" class="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Change Role
                    </button>
                    
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-900">Night Mode</span>
                        <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full ${APP.darkMode ? 'bg-green-600' : 'bg-gray-300'}">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition ${APP.darkMode ? 'translate-x-6' : 'translate-x-1'}"></span>
                        </button>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="font-medium mb-3 text-gray-900">Statistics</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-gray-50 p-2 rounded">
                                <p class="text-gray-600">Total Plants</p>
                                <p class="font-medium text-gray-900">${APP.plants.length}/50</p>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <p class="text-gray-600">Need Water</p>
                                <p class="font-medium text-red-600">${APP.plants.filter(p => calculatePlantStatus(p).status === 'Due').length}</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeQuickPanel()" class="w-full p-2 text-gray-600 hover:text-gray-900">
                        Close
                    </button>
                </div>
            </div>
        `;
    }

    // =====================================
    // ACTIONS
    // =====================================

    async function selectRole(role) {
        APP.role = role;
        localStorage.setItem('role', role);
        await loadData();
        renderApp();
    }

    function toggleFilter(type, value) {
        APP.filters[type] = APP.filters[type] === value ? null : value;
        renderApp();
    }

    function setFilter(type, value) {
        APP.filters[type] = value || null;
        renderApp();
    }

    function closeQuickPanel() {
        document.getElementById('quickPanel').innerHTML = '';
    }

    function toggleDarkMode() {
        APP.darkMode = !APP.darkMode;
        localStorage.setItem('darkMode', APP.darkMode.toString());
        document.body.classList.toggle('dark-mode', APP.darkMode);
        renderApp();
    }

    function changeRole() {
        localStorage.removeItem('role');
        APP.role = null;
        closeQuickPanel();
        renderApp();
    }

    async function waterWithInterval(plantId) {
        const plant = APP.plants.find(p => p.id === plantId);
        const newInterval = parseInt(document.getElementById('waterInterval').value);
        const moisture = document.getElementById('waterMoisture').value;
        
        try {
            // Update the plant's water interval if changed
            if (newInterval !== plant.waterIntervalDays) {
                await fetch(`/api/plants/${plantId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ waterIntervalDays: newInterval })
                }).catch(async () => {
                    // Fallback to PUT
                    await fetch(`/api/plants/${plantId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...plant, waterIntervalDays: newInterval })
                    });
                });
            }
            
            // Record the watering
            await fetch(`/api/plants/${plantId}/water`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ performedBy: APP.role })
            });
            
            // Record care event with details
            await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'water',
                    eventType: 'water',
                    soilMoisture: moisture,
                    intervalDaysChosen: newInterval,
                    performedBy: APP.role
                })
            }).catch(() => {});
            
            showToast(`Plant watered! Interval: ${newInterval} days`, 'success');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error watering plant', 'error');
        }
    }
    
    async function fertilizePlant(plantId) {
        try {
            // Update last fertilized date
            await fetch(`/api/plants/${plantId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lastFertilizedAt: new Date().toISOString() })
            }).catch(() => {});
            
            // Record care event
            await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'fertilize',
                    eventType: 'fertilize',
                    performedBy: APP.role
                })
            }).catch(() => {});
            
            showToast('Plant fertilized!', 'success');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error fertilizing plant', 'error');
        }
    }
    
    async function snoozeFertilizer(plantId, days) {
        try {
            await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'snooze',
                    eventType: 'snooze',
                    snoozeDays: days,
                    performedBy: APP.role,
                    notes: `Fertilizing snoozed for ${days} days`
                })
            });
            
            showToast(`Fertilizing snoozed for ${days} days`, 'info');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error setting snooze', 'error');
        }
    }

    async function quickWater(plantId) {
        try {
            await fetch(`/api/plants/${plantId}/water`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ performedBy: APP.role })
            });
            
            // Record care event
            await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'water',
                    eventType: 'water',
                    performedBy: APP.role
                })
            }).catch(() => {});
            
            showToast('Plant watered!', 'success');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error watering plant', 'error');
        }
    }

    async function recordCheck(plantId) {
        const moisture = document.getElementById('checkMoisture')?.value || document.getElementById('moisture')?.value;
        const note = document.getElementById('quickNote')?.value;
        
        if (!moisture && !note) {
            showToast('Please select moisture level or add a note', 'warning');
            return;
        }
        
        try {
            // Always send the care event to be recorded in history
            const response = await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'check',
                    eventType: 'check',
                    soilMoisture: moisture || null,
                    notes: note || null,
                    performedBy: APP.role,
                    performedAt: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                console.error('Failed to record check:', await response.text());
            }
            
            showToast(`Check recorded${moisture ? ` - ${moisture}` : ''}`, 'success');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            console.error('Error recording check:', error);
            showToast('Error recording check', 'error');
        }
    }

    async function snoozeQuick(plantId, days) {
        try {
            await fetch('/api/care-events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plantId,
                    role: APP.role,
                    type: 'snooze',
                    eventType: 'snooze',
                    snoozeDays: days,
                    performedBy: APP.role,
                    notes: `Snoozed for ${days} days`
                })
            });
            
            showToast(`Snoozed for ${days} days`, 'info');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error setting snooze', 'error');
        }
    }

    async function updatePlant(plantId) {
        const updates = {
            species: document.getElementById('editSpecies').value,
            nickname: document.getElementById('editNickname').value || null,
            roomId: parseInt(document.getElementById('editRoomId').value),
            lightLevel: document.getElementById('editLightLevel').value,
            waterIntervalDays: parseInt(document.getElementById('editWaterInterval').value),
            fertilizeIntervalDays: parseInt(document.getElementById('editFertilizeInterval').value)
        };
        
        try {
            // Try multiple endpoints for compatibility
            const response = await fetch(`/api/plants/${plantId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            }).catch(() => null);
            
            if (!response || !response.ok) {
                // Try PUT as fallback
                await fetch(`/api/plants/${plantId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
            }
            
            showToast('Plant updated', 'success');
            await loadData();
            closeQuickPanel();
            renderApp();
        } catch (error) {
            showToast('Error updating plant', 'error');
        }
    }

    async function deletePlant(plantId) {
        try {
            await fetch(`/api/plants/${plantId}`, { method: 'DELETE' });
            showToast('Plant deleted', 'success');
            closeQuickPanel();
            await loadData();
            renderApp();
        } catch (error) {
            showToast('Error deleting plant', 'error');
        }
    }

    function showAddPlantForm() {
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6 overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Add New Plant</h2>
                
                <form onsubmit="event.preventDefault(); addPlant()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Species *</label>
                        <input type="text" id="newSpecies" required class="w-full p-2 border rounded-lg">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Nickname</label>
                        <input type="text" id="newNickname" class="w-full p-2 border rounded-lg">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Room *</label>
                        <select id="newRoomId" required class="w-full p-2 border rounded-lg">
                            ${APP.rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-900">Light Level *</label>
                        <select id="newLightLevel" required class="w-full p-2 border rounded-lg">
                            <option value="low">☁️ Low</option>
                            <option value="medium">⛅ Medium</option>
                            <option value="bright">☀️ Bright</option>
                            <option value="direct">🌞 Direct</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-900">Water Every (days) *</label>
                            <input type="number" id="newWaterInterval" required value="7" min="1" max="60" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-900">Fertilize Every (days)</label>
                            <input type="number" id="newFertilizeInterval" value="30" min="7" max="120" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full p-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Add Plant
                    </button>
                </form>
                
                <button onclick="closeQuickPanel()" class="w-full mt-2 p-2 text-gray-600 hover:text-gray-900">
                    Cancel
                </button>
            </div>
        `;
    }

    async function addPlant() {
        const plantData = {
            species: document.getElementById('newSpecies').value,
            nickname: document.getElementById('newNickname').value || null,
            roomId: parseInt(document.getElementById('newRoomId').value),
            lightLevel: document.getElementById('newLightLevel').value,
            waterIntervalDays: parseInt(document.getElementById('newWaterInterval').value),
            fertilizeIntervalDays: parseInt(document.getElementById('newFertilizeInterval').value || 30),
            addedBy: APP.role
        };
        
        try {
            await fetch('/api/plants', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(plantData)
            });
            
            showToast('Plant added!', 'success');
            closeQuickPanel();
            await loadData();
            renderApp();
        } catch (error) {
            showToast('Error adding plant', 'error');
        }
    }

    function showRooms() {
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6 overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Rooms</h2>
                
                <div class="space-y-2 mb-4">
                    ${APP.rooms.map(room => {
                        const plantCount = APP.plants.filter(p => p.roomId == room.id).length;
                        return `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-900">${room.name}</p>
                                    <p class="text-sm text-gray-600">${plantCount} plants</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <button onclick="closeQuickPanel()" class="w-full p-2 text-gray-600 hover:text-gray-900">
                    Close
                </button>
            </div>
        `;
    }

    function showExport() {
        document.getElementById('quickPanel').innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeQuickPanel()"></div>
            <div class="slide-panel bg-white rounded-t-2xl shadow-xl p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Export Data</h2>
                
                <button onclick="exportCSV()" class="w-full p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 mb-2">
                    📊 Export as CSV
                </button>
                
                <button onclick="closeQuickPanel()" class="w-full mt-4 p-2 text-gray-600 hover:text-gray-900">
                    Close
                </button>
            </div>
        `;
    }

    function exportCSV() {
        const plantsCSV = [
            ['ID', 'Species', 'Nickname', 'Room', 'Light', 'Water Days', 'Last Watered'],
            ...APP.plants.map(p => [
                p.id,
                p.species,
                p.nickname || '',
                APP.rooms.find(r => r.id == p.roomId)?.name || '',
                p.lightLevel,
                p.waterIntervalDays,
                p.lastWateredAt || ''
            ])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([plantsCSV], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `plants-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        showToast('Data exported', 'success');
    }

    // =====================================
    // DATA LOADING
    // =====================================

    async function loadData() {
        try {
            let rooms = [];
            try {
                const roomsRes = await fetch('/api/rooms');
                if (roomsRes.ok) rooms = await roomsRes.json();
            } catch (e) {
                console.log('Rooms API issue');
            }
            
            let plants = [];
            try {
                const plantsRes = await fetch('/api/plants');
                if (plantsRes.ok) plants = await plantsRes.json();
            } catch (e) {
                console.log('Plants API issue');
            }
            
            let events = [];
            try {
                const eventsRes = await fetch('/api/care-events');
                if (eventsRes.ok) events = await eventsRes.json();
            } catch (e) {
                console.log('Care events not ready');
            }
            
            APP.rooms = rooms || [];
            APP.plants = plants || [];
            APP.careEvents = events || [];
            
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    // =====================================
    // INITIALIZATION
    // =====================================

    async function init() {
        if (APP.role) {
            await loadData();
        }
        renderApp();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (APP.role) loadData().then(renderApp);
        }, 30000);
    }

    // Start app
    init();
    </script>
</body>
</html>
